= Digger : Documenting Database Schemes
Hildeberto Mendonca <me@hildeberto.com>
v1.5.0
:doctype: book
:encoding: utf-8
:toc: left
:toclevels: 4
:numbered:

Digger is a light-weight web application to centralize and share the accumulated collective knowledge about all the relational databases of the organization.

:sectnums!:

== Introduction

After decades of software development, we realized that data is more valuable than software. An application is more likely to be rewritten in a modern technology and continue pointing to an existing database than an existing application be modified to access data from a different database. Of course both cases exist, but applications tend to become more chaotic than databases.

Even with a longer time span, databases are rarely documented. Often, developers have to read the code to understand the meaning of tables, views, columns, and how to use them. It is not rare to find columns and tables that are not referenced at all, but we never know whether they are still in use by an obscure trigger, stored procedure or third-part application. If at least they had a defragmented and up-to-date documentation they could rely on.

:sectnums:

== Installation

Digger is easy to install but it requires Java 8+ installed and configured in the system. The application comes with an embedded database for simple use cases, but it can also be configured to store data in a PostgreSQL database server, which also has to be installed and configured separately.

=== Installing the Released File

Download Digger from the https://github.com/htmfilho/digger/releases[release page] and save it where you want to install it. That is a `jar` file with the naming convention: `digger-<version>.jar`. For example: `digger-1.2.0.jar`.

==== Using the Embedded Storage

To run Digger with its default configuration, go to the terminal and execute:

    $ cd <path-to-digger-folder>
    $ java -jar digger-1.2.0.jar

A few moments later, open your browser and visit the address http://localhost:8080 to use Digger with its embedded database. The folder `data` is automatically created during the initialization and the sign up page below is presented by default.

.Initial Setup
image::images/initial-setup.png[]

==== Using PostgreSQL Storage

The embedded database is robust enough to support a reasonable volume of data, but it won't scale to support multiple concurrent users. For that, you can use PostgreSQL to handle a larger demand for information. To switch to PostgreSQL:

1. if the application is already running, stop it using `[Ctrl+C]` in the terminal

2. create a sub-directory named `config` in the same directory of the application

3. download the files https://raw.githubusercontent.com/htmfilho/digger/master/config/application.properties[`application.properties`] and https://raw.githubusercontent.com/htmfilho/digger/master/config/application-server.properties[`application-server.properties`] and save them in the `config` folder

4. open the file `application.properties` and change the following entry from `embedded` to `server`:

    spring.profiles.active=server

5. Then open the file `application-server.properties` and change the following connection parameters to your PostgreSQL server:

    spring.datasource.driver-class-name=org.postgresql.Driver
    spring.datasource.url=jdbc:postgresql://localhost:5432/digger
    spring.datasource.username=digger_usr
    spring.datasource.password=secret

6. Restart the application to take the new configuration into account:

    $ java -jar digger-1.2.0.jar

7. Finally, refresh the page http://localhost:8080

Make sure the database user has full rights over Digger's database, so it can generate the schema and perform all operations.

=== Installing From Source

A new version of Digger is released from time to time, but if you can't wait for a feature that was just finished, then you may need to build Digger from source. To do it, you need:

 - https://openjdk.java.net/[JDK], a Java Development Kit to compile and run the code,

 - https://maven.apache.org/[Maven], a traditional software life-cycle management tool for Java, and

 - https://git-scm.com/[Git], a distributed version control system. Please, visit their respective documentation and get them installed and configured in your system.

To start, fetch the code from GitHub:

    $ git clone https://github.com/htmfilho/digger.git

Then build the project:

    $ cd digger
    $ mvn package

All the artifacts you need are ready! The jar file is now available at `target/` and the configuration files at `config/`. You can run it using the java command:

    $ java -jar target/digger-1.2.0.jar

or Maven:

    $ mvn spring-boot:run

If you already have Digger installed, just put the generated jar file in the same folder of the existing installation and remove the old jar. Execute the new jar from that point on.

You can also get all subsequent changes whenever they are available by fetching updates:

    $ git pull origin master

Then you can package and run it:

    $ mvn clean package

=== Installing as a Local Service

Sometime, we spend so much time documenting database schemes that we want Digger to be constantly available. We also want it to start with the operating system in case the system needs to boot. Digger can be configured to start as a local service to address these cases.

=== A Linux Service

Create a new service file `digger.service` at `/etc/systemd/system` with the following content:

[source, toml]
----
[Unit]
Description = Digger - Database Schema Documentation Tool

[Service]
Type=simple
WorkingDirectory=/opt/digger
User=digger
Group=digger
StandardOutput=syslog+console
StandardError=syslog+console
ExecStart=/usr/bin/java -jar /opt/digger/digger-standalone.jar

[Install]
WantedBy=multi-user.target
----

Then execute the following commands:

    $ sudo systemctl daemon-reload
    $ sudo systemctl enable digger.service

=== A Windows Service

== Security

Digger ensures that only authorized people in the organization are allowed to document and to access the documentation of the schemes. Users are managed by the application and their passwords are strongly encrypted in the database, to the point they cannot be recovered, only reset.

[#signup]
=== Signing Up

When Digger starts for the first time, it forces the creation of the first user account by automatically redirecting the user to the Sign Up page. The role of administrator (ROLE_ADMIN) is automatically assigned to the first user, who is empowered to manage the application including other users.

.User Sign Up
image::images/signup.png[]

All people signing up after the first user are disabled and assigned to the role of Reader by default. That's why the user cannot login after the sign up. The administrator must enable the user and assign him or her to the appropriate role or leave the user as reader.

[#login]
=== Login

The login tries to match the user's credentials. If the matching is successful, the user is allowed into the application to access confidential information, otherwise the user is informed that the matching was unsuccessful.

.User authentication
image::images/login.png[]

[#profile]
=== User Profile

Once the login is successful, users have access to their profile by clicking on the user's menu on the top right and selecting *Profile*. This is a section that give information and some control over the user experience.

.User Profile
image::images/profile.png[]

[#change-password]
==== Changing Password

One of the capabilities available in the profile is the password change. Users are able to change their password whenever they feel it can improve their security. To change your password:

1. Click on the *Change Password* button available in the profile

2. fill in your current password to confirm your identity

3. fill in your new password in the *New Password* and *Confirm New Password* fields

4. Click on *Submit* to confirm the change or *Cancel* to return to the profile

.Changing Password
image::images/change-password.png[]

=== Protection Against CSRF

CSRF stands for https://en.wikipedia.org/wiki/Cross-site_request_forgery[Cross Site Request Forgery], a malicious exploit of web applications where unauthorized commands are triggered from users trusted by the application. Digger implements the measures to prevent this kind of attack.

== Features

Digger gives you a good set of features to help you document the database schemes of your organization.

[#admin]
=== Administration

The administration is accessible via the top menu, in the "Admin" option. It allows the administrator to manage user accounts.

image::images/administration.png[]

NOTE:: This feature is limited to administrators. Other roles won't see this option in the menu.

[#admin-users]
==== Users

Administrators need to have control over the users to ensure the confidentiality of the information managed by Digger. They can find in this section the essential to manage the users.

image::images/users.png[]

===== Enabling and Disabling a User

After signing up, a user doesn't have instant access to Digger. All users are disabled by default and the administrator has to enable them. To enable a user:

1. click on the "Admin" option on the top menu and select "Users" in the list
2. check the users you want to enable and uncheck the ones you want to disable

[#admin-user]
===== User's Details

In the *User's Details* section, the administration can see all information related to the user and related options such as *Edit* and *Delete*.

.User's Details
image::images/user.png[]

===== Changing the Role of a User

Digger defines 3 levels of authority represented by roles. They are:

- *Administrator*: has access to all functionalities of the system.

- *Editor*: has rights limited to document and visualize the documentation of the schemas.

- *Reader*: has rights limited to visualizing the documentation of the schema.

The first user of Digger is assigned to the role of Administrator and all subsequent users are assigned to the role of Reader. Only the administrator has the right to change the role of a user. To do this:

1. Click on the "Admin" option on the top menu and select "Users" in the list
2. click on the user you want to change
3. click on the button "Options" and select "Edit" in the list
4. select the role you want for that user and save

The only exception is when there is only one administrator and he or she tries to change his or her own role of administrator. The administrator needs to promote another user as administrator to be able to downgrade his or her own role.

image::images/user-form.png[]

[#datasources]
=== Datasources

Datasource is a reference to an existing database that we intend to document. A datasource has enough information to connect to the database and extract metadata from it.

image::images/datasources.png[]

[#datasource-form]
==== Creating and Editing a Datasource

To create a new datasource, click on the *New* button on the top right of the list of datasources. It opens the datasource form, where you can give it a *Name*, give more details about it in the *Description*, and inform the connection attributes. The *Driver Class* drop-down field offers a list of the currently supported database engines. Each driver requires a different URL format, so when a driver is selected, its corresponding URL template appears below the *URL* field for reference. Finally, inform a valid *Username* and *Password* with at least _Read_ privileges to the database. Click on *Save* to register the information or *Cancel* to go back to the datasource list.

image::images/datasource-form.png[]

To edit a datasource, click on it in the list. In the datasource page, click on the button *Options* on the top right, then select the option *Edit*. The same form appears, but this time completely filled. Make the intended changes and *Save*.

[#datasource]
==== A Datasource

The datasource page shows all information related to the datasource, as well as all possible operations such as *Edit*, *Remove*, *Add Table*, *Ignore Tables*, etc.

image::images/datasource.png[]

[#tables]
=== Tables

A datasource's Table is a tabular structure used to store, organize and retrieve data. It can be a database table, a temporary table, a view, and other vendor specific alternatives. They are listed in the datasource page, from where they can be reached and documented.

image::images/tables.png[]

[#table-form]
==== Documenting a Table

To document a table, go to the datadource that the table belongs to, then to the "Tables" section, and click on the *New* button on the right. Fill-in the form by selecting the *Physical Name* of the table in the dropdown, confirming the type that is automatically detected, a friendly name that is more readable than the physical mame, and write down everything you know about that table.

Click on the *Save* button to complete or *Cancel* to go back to the datasource page.

image::images/table-form.png[]

The *Documentation* field uses https://asciidoctor.org/docs/what-is-asciidoc/[Asciidoc] as markup language. It has a human friendly syntax to allow anybody write rich content without touching any HTML or CSS code.

Visit the Appendix A to learn everything you need to know to properly format your documentation.

[#table]
==== A Table

The table's page shows all information related to the table, including its columns and dependencies. To edit a table, click on the *Options* button on the top right then select the option *Edit*. The form appears filled with the table's attributes and documentation. Make the intended changes and save, or cancel to return to the table's page.

image::images/table.png[]

The tab *Referenced By* shows a list of tables that have foreign keys pointing to one of more columns of the table. It is useful for understanding the impact of changing the table or its records.

[#ignored-tables]
=== Ignored Tables

image::images/ignored-tables.png[]

[#ignored-tables-form]
==== Ignoring Tables

image::images/ignoring-tables.png[]

[#columns]
=== Columns

[#column-form]
==== Documenting a Column

To document a column of a table, go to the table that the column belongs to, go to the *Columns* tab and click on the *New* button on the right. Fill in the form by selecting the *Physical Name*, writing a human friendly name that is equivalent to the physical name, and verify the fields that are automatically filled.

If the column is a foreign key, select the reference table and the column that the key points to. The documentation of the selection is presented right below to assist on the documentation of the current field.

Finally, describe in details what the field is useful for, why it is important for the business, exceptional cases, historical decisions, etc.

image::images/column-form.png[]

Click on *Save* to keep the information or *Cancel* to go back to the table's page.

[#column]
==== A Column

image::images/column.png[]

=== When Things Go Wrong

If you faced issues while using the above features, we are deeply sorry about that and we want to improve your experience. For that, we need your help to share information about the issue so we can effectively address that.

The procedure to report a issue is simple:

1. Go to the https://github.com/htmfilho/digger/issues[Issues] section on our GitHub repository and create a new issue

2. Write in the *Title* a short overview of the issue

3. Describe in the comments more details about the issue

4. If possible, attach a screenshot if the issue is visible on the user interface

5. Attach the most recent log file you can find in the folder `logs/`, which is created side by side with the `data/` and the `config/` folders

6. Click on *Submit new issue* to finish

We will be immediately notified and analyze the issue with the highest priority.

== Contributing to the Project

Follow these instructions if you want to contribute to Digger.

=== Assumptions

We assume your development environment is configured with:

 - **Java 8+**: you can perform the commands `java` and `javac` in your terminal
 - **Maven 3**: you can perform the command `mvn` in your terminal
 - **Git**: you can perform the command `git` in your terminal

=== Local Environment Setup

We favour the use of the command line to set up the local environment, so we do not depend on any other tool for this basic step. Open the Windows/Linux terminal and start by cloning the repository in your local machine:

    $ cd [your-java-projects-folder]
    $ git clone https://github.com/htmfilho/digger.git

It creates the folder `digger` that contains the entire source code of the application. Execute the following Maven command to build, test, and run the application:

    $ cd digger
    $ mvn spring-boot:run

Visit the local address http://localhost:8080/ to use the application. To stop it, type `Ctrl+C` on the terminal.

=== Data Model

The data managed by Digger is persisted in a relational database. If you launched Digger as is, without changing the configuration, you are using the embedded database https://www.h2database.com[H2]. If you are using the server configuration then you are using https://www.postgresql.org/[PostgreSQL]. The data is organized according to the following diagram.

.Digger's Entity Relational Model
image::images/entity-relationship-diagram.png[]

=== Test Automation

To execute the test suite, run:

    $ mvn test

Only submit your pull request if these tests pass. To see the test coverage report, open the page generated at `target/site/jacoco`.

=== Technologies in Use

 - https://docs.spring.io/spring/docs/current/spring-framework-reference/web.html[Spring MVC]
 - https://spring.io/projects/spring-security[Spring Security]
 - http://www.thymeleaf.org[Thymeleaf]
 - https://www.h2database.com[H2]
 - https://www.postgresql.org/[PostgreSQL]

=== Using Git

Git is a distributed version control system used to manage the source code of Digger. We can use apt-get to install Git:

    $ sudo apt-get install git

Since version 2.0, Git has adopted a new behavior to pull and push commits while in a branch. When you execute git push or git pull Git will consider pushing or pulling just for the current branch. Before, these commands would push and pull all branches. But the change to this new behavior is voluntary, not automatically imposed. So, we have to explicitly say we have to move from the old behavior to the new one. To do that, execute the following command:

    $ git config --global push.default simple

==== Configuring Git to Simplify Authentication

For the moment, every time we push code to GitHub the prompt asks for a username and password. We can bypass this step by registering a SSH key. To do that, we first check whether there is already an existing SSH key we can reuse:

    $ ls -al ~/.ssh

If files with the extension .pub are listed then one of them can be reused to authenticate to GitHub. If not, then we can create one:

    $ ssh-keygen -t rsa -b 4096 -C "[firstname.lastname]@domain.com"
      Enter file in which to save the key (/Users/[user]/.ssh/id_rsa): [Press enter]
      Enter passphrase (empty for no passphrase): [Type a passphrase]
      Enter same passphrase again: [Type passphrase again]

The next step is to add the new key - or an existing one - to the ssh-agent. This program runs the duration of a local login session, stores unencrypted keys in memory, and communicates with SSH clients using a Unix domain socket. Everyone who is able to connect to this socket also has access to the ssh-agent. First, we have to enable the ssh-agent:

    $ eval "$(ssh-agent -s)"

And add key to it:

    $ ssh-add ~/.ssh/id_rsa

The next step is to make GitHub aware of the key. For that, we have to copy the exact content of the file `id_rsa.pub` and paste into GitHub. To make no mistake about the copy, install a program called xclip:

    $ sudo apt-get install xclip

And then copy the content of the file `id_rsa.pub` in the clipboard:

    $ xclip -sel clip < ~/.ssh/id_rsa.pub

The command above is the equivalent of opening the file `~/.ssh/id_rsa.pub`, selecting the whole content and pressing `Ctrl+C`. This way, you can paste the content on GitHub when required in the next steps. On the GitHub side:

1. Login at https://github.com

2. In the top right corner of the page, click on the profile photo and select Settings

3. In the user settings sidebar, click SSH keys

4. Then click Add SSH key

5. In the form, define a friendly title for the new key and paste the key in the Key field

6. Click Add Key to finish with GitHub

To make sure everything is working, lets test the connection:

    $ ssh -T git@github.com
      The authenticity of host 'github.com (207.97.227.239)' can't be established.
      RSA key fingerprint is 16:27:ac:a5:76:28:2d:36:63:1b:56:4d:eb:df:a6:48.
      Are you sure you want to continue connecting (yes/no)? yes
      _
      Hi [username]! You've successfully authenticated, but GitHub does not
      provide shell access.

We can test the installation by cloning the Digger repository:

    $ mkdir -p ~/java/projects/digger
    $ cd ~/java/projects/digger
    $ git clone git@github.com:htmfilho/digger.git .

This configuration works only when we use a ssh connection to GitHub. To verify that, go to one of your local GitHub projects and check the url pointing to the server:

    $ cd ~/java/projects/digger
    $ git remote -v

If the url starts with https:// then you are using https instead of ssh. In this case, you should change the url to the ssh one:

    $ git remote set-url origin git@github.com:htmfilho/digger.git

The automatic authentication should work after that.

==== Changing The Author To The One Recognizable by GitHub

In case your default Git author is not the same as GitHub, configure the author of the repository:

    $ git config user.name "John Doe"
    $ git config user.email "john@doe.org"

It can also be done to a specific commit:

    $ git commit --author="John Doe <john@doe.org>"

==== Changing Several Commits in Bulk

If commits were done with a wrong author, use Git Rebase to fix the authors of the commits:

    $ git rebase -i -p <commit-id>
    $ git commit --amend --author="John Doe <john@doe.org>"
    $ git rebase --continue
    $ git push -f origin master

==== Adding a File to the Most Recent Commit

    $ git add missed-file.txt
    $ git commit --amend

:sectnums!:

=== The Release Process

1. Review the tickets that are going to be released.

2. Review the documentation to make sure it covers all the recent changes.

3. Increment the version number in the documentation to the version that is about to be released.

4. Generate the HTML version of the documentation:

    $ asciidoctor docs/index.adoc

5. Commit all the changes in the documentation:

    $ git add [list-of-modified-files]
    $ git commit -m "Updated the documentation for the release 1.3.0"

6. Check if there is any missing file to be committed in the project.

7. Push all local changes to the release branch:

    $ git push origin 1.5.0

8. Create a pull request to merge the release branch with the master branch, review the code to be merged and merge it.

9. Create the next milestone.

10. Move the unfinished work in the current milestone to the next milestone.

11. Close the current milestone.

12. Write the release notes.

13. Generate the package:

    $ mvn clean package

14. Upload the package to the release page.

15. Publish the release.

16. Create a branch for the next release:

    $ git checkout -b 1.5.0

17. Increment the version number in the pom file and commit it:

    $ git add pom.xml
    $ git commit -m "Incremented release number to 1.5.0"

18. Push the new branch to `origin`:

    $ git push origin 1.5.0

19. Announce the new release to the community and on social networks.

== Appendix A: Asciidoc Syntax

Asciidoc is a markup language in plain text that can be easily transformed into other convenient formats such as HTML, PDF, etc. When you use Asciidoc to write the database documentation, Digger has a minimal effort to provide content in other formats for your confort.

=== A Paragraph

The content is organized in blocks separated by empty lines. In other words, by simply putting an empty line between two sentences we get two paragraphs. Breaking the content in consecutive lines keep it within the same paragraph. If you want line breaks within a paragraph, use the `+` symbol at the end of the line.

To draw attention to a paragraph, you can use `NOTE`, `TIP`, `IMPORTANT`, `CAUTION`, `WARNING`:
